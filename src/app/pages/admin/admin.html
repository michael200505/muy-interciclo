<!-- FILE: src/app/pages/admin/admin.html -->
<app-header></app-header>

<page-container class="page page--admin anim-in">
  <div class="section-head">
    <div>
      <h1>Panel de Administrador</h1>
      <p>Gestiona usuarios, perfiles de programador y disponibilidad.</p>
    </div>
    <span class="pill pill--ok">Listo</span>
  </div>

  <div class="stack">
    <!-- ===================== USUARIOS ===================== -->
    <section class="card anim-in">
      <h2>Gestión de Usuarios</h2>
      <p class="muted">Crea, edita o elimina perfiles de programador y asigna permisos.</p>

      <div *ngIf="loading" class="pill pill--neutral" style="margin-top:10px;">
        Cargando...
      </div>

      <!-- LISTA “VERTICAL” RESPONSIVE (sin montajes) -->
      <table class="table" *ngIf="!loading && !selectedUser">
        <thead>
          <tr>
            <th>Usuario</th>
            <th>Correo</th>
            <th>Rol</th>
            <th style="width: 320px;">Acción</th>
          </tr>
        </thead>

        <tbody>
          <tr *ngFor="let user of allUsers">
            <td data-label="Usuario">
              <div class="user">
                <div class="avatar">
                  {{ (user.displayName || 'U').slice(0, 1) }}
                </div>

                <div class="u-meta">
                  <div class="u-name">{{ user.displayName || '—' }}</div>
                  <div class="u-id mono">{{ user.uid }}</div>
                </div>
              </div>
            </td>

            <td data-label="Correo">
              <span class="mono wrap">{{ user.email || '—' }}</span>
            </td>

            <td data-label="Rol">
            <span class="pill" [class.pill--ok]="hasProgrammerProfile(user.uid)">
           {{ hasProgrammerProfile(user.uid) ? 'programador' : 'usuario' }}
           </span>
            </td>


            <td data-label="Acción" class="cell-actions">
              <div class="actions-col">
                <!-- Si NO tiene perfil -->
                <button
                  *ngIf="!hasProgrammerProfile(user.uid)"
                  class="primary-btn"
                  (click)="startProgrammerSetup(user)">
                  Convertir a programador
                </button>

                <!-- Si YA tiene perfil -->
                <ng-container *ngIf="hasProgrammerProfile(user.uid)">
                  <button class="ghost-btn" (click)="startProgrammerSetup(user)">
                    Editar perfil
                  </button>

                  <button class="danger-btn" (click)="deleteProgrammerProfile(user)">
                    Eliminar perfil
                  </button>
                </ng-container>
              </div>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- FORM PERFIL PROGRAMADOR -->
      <div *ngIf="selectedUser" class="form-box anim-in" style="margin-top:14px;">
        <h2>
          {{ editingExisting ? 'Editar Perfil de:' : 'Crear Perfil para:' }}
          {{ selectedUser.displayName }}
        </h2>

        <div class="grid2">
          <div>
            <label>Nombre</label>
            <input [(ngModel)]="newProgrammer.name" type="text">
          </div>

          <div>
            <label>Especialidad</label>
            <input [(ngModel)]="newProgrammer.specialty" type="text">
          </div>
        </div>

        <label>Descripción</label>
        <textarea [(ngModel)]="newProgrammer.description"></textarea>

        <label>Foto URL</label>
        <input [(ngModel)]="newProgrammer.photoURL" type="text">

        <hr>

        <h3>Contactos</h3>
        <div class="grid2">
          <div>
            <label>Email</label>
            <input [(ngModel)]="contactLinksSafe.email" type="text">
          </div>
          <div>
            <label>LinkedIn</label>
            <input [(ngModel)]="contactLinksSafe.linkedin" type="text">
          </div>
          <div>
            <label>GitHub</label>
            <input [(ngModel)]="contactLinksSafe.github" type="text">
          </div>
          <div>
            <label>WhatsApp</label>
      <input [(ngModel)]="contactLinksSafe.whatsapp" type="text">
          </div>
        </div>

        <div class="btn-group">
          <button (click)="saveProgrammerProfile()" class="primary-btn">
            {{ editingExisting ? 'Guardar cambios' : 'Guardar y convertir' }}
          </button>

          <button (click)="cancelEdit()" class="ghost-btn">Cancelar</button>
        </div>
      </div>
    </section>

    <!-- ===================== DISPONIBILIDAD ===================== -->
    <section class="form-box anim-in">
      <h2>Disponibilidad de Programadores</h2>

      <div class="grid3" style="margin-top:10px;">
        <div>
          <label>Programador</label>
          <select [(ngModel)]="selectedProgrammerId" (change)="loadSlots()">
            <option value="">-- Selecciona --</option>
            <option *ngFor="let p of programmers" [value]="p.uid">{{ p.name }}</option>
          </select>
        </div>

        <div>
          <label>Filtrar por fecha (opcional)</label>
          <input type="date" [(ngModel)]="slotDate" (change)="loadSlots()"/>
        </div>

        <div>
          <label>Hora</label>
          <input type="time" [(ngModel)]="slotHour"/>
        </div>
      </div>

      <div class="btn-group" style="justify-content:flex-end;">
        <button class="primary-btn" (click)="addSlot()">Agregar hora</button>
      </div>

      <div style="margin-top:12px;">
        <div *ngIf="loadingSlots" class="pill pill--neutral">Cargando horarios...</div>

        <div *ngIf="!loadingSlots && selectedProgrammerId && slots.length === 0" class="card" style="margin-top:10px;">
          No hay horarios registrados.
        </div>

        <div *ngIf="!loadingSlots && selectedProgrammerId && slots.length > 0" class="card" style="margin-top:10px; padding:12px;">
          <div *ngFor="let s of slots" class="slot-row">
            <div class="slot-left">
              <b>{{ s.date }}</b>
              <span class="dot">•</span>
              <span>{{ s.hour }}</span>
              <span class="pill">{{ s.status }}</span>
            </div>
            <button class="danger-btn" (click)="removeSlot(s)">Eliminar</button>
          </div>
        </div>
      </div>
    </section>
  </div>
</page-container>

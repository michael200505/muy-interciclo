<app-header></app-header>

<page-container class="page page--admin">
  <div class="admin-shell" @fadeUp>
    <div class="section-head">
      <div>
        <h1 class="title">
          <span class="title__spark" aria-hidden="true"></span>
          Panel de Administrador
        </h1>
        <p>Gestiona usuarios, perfiles de programador y disponibilidad.</p>
      </div>
    </div>

    <div class="stack">
      <!-- ================= USERS ================= -->
      <section class="card admin-card" @panelIn>
        <div class="card-head">
          <div>
            <h2>Gestión de Usuarios</h2>
            <p class="card-sub">Crea perfiles de programador y asigna permisos.</p>
          </div>

          <div class="head-actions">
            <span
              *ngIf="loading"
              class="pill pill--neutral"
              aria-live="polite"
              >Cargando...</span
            >
            <span *ngIf="!loading" class="pill pill--ok">Listo</span>
          </div>
        </div>

        <div *ngIf="loading" class="skeleton">
          <div class="sk-row" *ngFor="let _ of [1, 2, 3, 4, 5]">
            <div class="sk sk-a"></div>
            <div class="sk sk-b"></div>
            <div class="sk sk-c"></div>
            <div class="sk sk-d"></div>
          </div>
        </div>

        <table class="table" *ngIf="!loading && !selectedUser">
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Correo electrónico</th>
              <th>Rol</th>
              <th style="width: 240px;">Acción</th>
            </tr>
          </thead>

          <tbody>
            <tr *ngFor="let user of allUsers">
              <td data-label="Nombre">
                <div class="usercell">
                  <div class="avatar" aria-hidden="true">
                    <span>{{ (user.displayName || 'U').slice(0, 1) }}</span>
                  </div>
                  <div class="usercell__meta">
                    <b>{{ user.displayName }}</b>
                    <span class="muted">{{ user.uid }}</span>
                  </div>
                </div>
              </td>

              <td data-label="Correo electrónico">{{ user.email }}</td>

              <td data-label="Rol">
                <span class="pill" [ngClass]="'pill--' + user.role">
                  {{ user.role }}
                </span>
              </td>

              <td data-label="Acción" class="cell-actions">
                <button class="ghost-btn" (click)="startProgrammerSetup(user)">
                  Crear Perfil Programador
                </button>
              </td>
            </tr>
          </tbody>
        </table>

        <!-- ================= FORM ================= -->
        <div
          *ngIf="selectedUser"
          class="form-box form-panel"
          style="margin-top:14px;"
          @panelIn
        >
          <div class="form-head">
            <div>
              <h2>Crear Perfil</h2>
              <p class="muted">
                Para: <b>{{ selectedUser.displayName }}</b>
              </p>
            </div>

            <button (click)="selectedUser = null" class="ghost-btn">
              Cerrar
            </button>
          </div>

          <div class="grid2">
            <div>
              <label>Nombre</label>
              <input [(ngModel)]="newProgrammer.name" type="text" />
            </div>

            <div>
              <label>Especialidad</label>
              <input [(ngModel)]="newProgrammer.specialty" type="text" />
            </div>
          </div>

          <label>Descripción</label>
          <textarea [(ngModel)]="newProgrammer.description"></textarea>

          <label>Foto URL</label>
          <input [(ngModel)]="newProgrammer.photoURL" type="text" />

          <hr />

          <h3>Contactos</h3>
          <div class="grid2">
            <div>
              <label>Email</label>
              <input [(ngModel)]="newProgrammer.contactLinks.email" type="text" />
            </div>
            <div>
              <label>LinkedIn</label>
              <input
                [(ngModel)]="newProgrammer.contactLinks.linkedin"
                type="text"
              />
            </div>
            <div>
              <label>GitHub</label>
              <input [(ngModel)]="newProgrammer.contactLinks.github" type="text" />
            </div>
            <div>
              <label>WhatsApp</label>
              <input
                [(ngModel)]="newProgrammer.contactLinks.whatsapp"
                type="text"
              />
            </div>
          </div>

          <div class="btn-group">
            <button (click)="saveProgrammerProfile()" class="primary-btn">
              Guardar
            </button>
            <button (click)="selectedUser = null" class="ghost-btn">
              Cancelar
            </button>
          </div>
        </div>
      </section>

      <!-- ================= AVAILABILITY ================= -->
      <section class="form-box admin-card" @panelIn>
        <div class="card-head">
          <div>
            <h2>Disponibilidad de Programadores</h2>
            <p class="card-sub">Registra horas disponibles por programador.</p>
          </div>
        </div>

        <div class="grid3" style="margin-top:10px;">
          <div>
            <label>Programador</label>
            <select [(ngModel)]="selectedProgrammerId" (change)="loadSlots()">
              <option value="">-- Selecciona --</option>
              <option *ngFor="let p of programmers" [value]="p.uid">
                {{ p.name }}
              </option>
            </select>
          </div>

          <div>
            <label>Filtrar por fecha (opcional)</label>
            <input type="date" [(ngModel)]="slotDate" (change)="loadSlots()" />
          </div>

          <div>
            <label>Hora</label>
            <input type="time" [(ngModel)]="slotHour" />
          </div>
        </div>

        <div class="btn-group" style="justify-content:flex-end;">
          <button class="primary-btn" (click)="addSlot()">Agregar hora</button>
        </div>

        <div style="margin-top:12px;">
          <div *ngIf="loadingSlots" class="pill pill--neutral">
            Cargando horarios...
          </div>

          <div
            *ngIf="!loadingSlots && selectedProgrammerId && slots.length === 0"
            class="empty card"
            style="margin-top:10px;"
          >
            No hay horarios registrados.
          </div>

          <div
            *ngIf="!loadingSlots && selectedProgrammerId && slots.length > 0"
            class="card slot-card"
            style="margin-top:10px; padding:12px;"
          >
            <div *ngFor="let s of slots" class="slot-row">
              <div class="slot-left">
                <b>{{ s.date }}</b>
                <span class="dot">•</span>
                <span>{{ s.hour }}</span>
                <span class="pill pill--neutral">{{ s.status }}</span>
              </div>
              <button class="danger-btn" (click)="removeSlot(s)">Eliminar</button>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>
</page-container>
